<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Быстрый счет</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: 'Segoe UI', system-ui, sans-serif; padding: 24px; margin: 0; background: linear-gradient(135deg, #0c1929 0%, #132f4c 50%, #0e3a5f 100%); color: #e8f4fc; min-height: 100vh; }
    h1 { font-size: 1.5rem; margin: 0 0 8px; font-weight: 700; }
    .subtitle { color: #90caf9; margin: 0 0 24px; font-size: 0.9rem; opacity: 0.9; }
    .level-row { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 24px; }
    .level-btn { padding: 10px 18px; font-size: 0.95rem; border: 2px solid #1565c0; background: rgba(21, 101, 192, 0.2); color: #90caf9; border-radius: 10px; cursor: pointer; transition: all 0.2s; }
    .level-btn:hover, .level-btn.active { background: #1565c0; color: #fff; border-color: #1976d2; }
    .task-box { padding: 32px; background: rgba(0,0,0,0.25); border-radius: 20px; border: 2px solid #1976d2; margin: 24px 0; text-align: center; min-height: 140px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .task-box .expr { font-size: 2.4rem; font-weight: 800; margin: 0 0 20px; letter-spacing: 0.05em; color: #fff; }
    .task-box .expr.correct { animation: correct 0.35s ease; color: #66bb6a; }
    .task-box .expr.wrong { animation: wrong 0.35s ease; color: #ef5350; }
    @keyframes correct { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    @keyframes wrong { 0% { transform: translateX(0); } 25% { transform: translateX(-6px); } 75% { transform: translateX(6px); } 100% { transform: translateX(0); } }
    label { display: block; margin-bottom: 8px; color: #90caf9; font-size: 0.9rem; }
    input { font-size: 1.4rem; padding: 14px 20px; width: 120px; text-align: center; border: 2px solid #1976d2; border-radius: 12px; background: rgba(0,0,0,0.3); color: #fff; }
    input:focus { outline: none; border-color: #42a5f5; box-shadow: 0 0 0 3px rgba(66, 165, 245, 0.3); }
    .stats { display: flex; gap: 24px; flex-wrap: wrap; margin: 20px 0; }
    .stat { padding: 12px 20px; background: rgba(0,0,0,0.2); border-radius: 12px; }
    .stat-label { font-size: 0.8rem; color: #64b5f6; text-transform: uppercase; }
    .stat-value { font-size: 1.4rem; font-weight: 700; color: #bbdefb; }
    .stat-value.streak { color: #ffb74d; }
    .timer-bar { height: 8px; background: rgba(0,0,0,0.3); border-radius: 4px; overflow: hidden; max-width: 320px; margin-top: 12px; }
    .timer-fill { height: 100%; background: linear-gradient(90deg, #42a5f5, #90caf9); border-radius: 4px; transition: width 0.1s linear; }
    .again { margin-top: 24px; padding: 14px 28px; font-size: 1rem; font-weight: 600; background: linear-gradient(135deg, #1976d2, #1565c0); color: #fff; border: none; border-radius: 12px; cursor: pointer; transition: transform 0.2s; }
    .again:hover { transform: translateY(-2px); }
    .a11y-bar { display: flex; gap: 16px; flex-wrap: wrap; align-items: center; margin-bottom: 16px; }
    .voice-toggle { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.9rem; color: #90caf9; }
    .voice-toggle input { width: auto; }
    .speak-btn { padding: 8px 16px; font-size: 0.9rem; background: rgba(0,0,0,0.3); color: #90caf9; border: 2px solid #1976d2; border-radius: 8px; cursor: pointer; }
    .speak-btn:hover, .speak-btn:focus { background: #1565c0; color: #fff; }
    button:focus-visible, input:focus-visible { outline: 3px solid #90caf9; outline-offset: 2px; }
    .keyboard-hint { font-size: 0.8rem; color: #64b5f6; margin-bottom: 12px; }
  </style>
</head>
<body>
  <main role="main" aria-label="Игра Быстрый счет">
  <h1>Быстрый счет</h1>
  <p class="keyboard-hint" id="keyboardHint">Управление: Tab - переход, Enter - отправить ответ или нажать кнопку, Пробел - нажать кнопку.</p>
  <p class="subtitle" id="instructions">Решите пример и нажмите Enter. Чем быстрее и правильнее - тем больше очков!</p>
  <button type="button" class="speak-btn" id="introBtn" aria-label="Озвучить инструкцию">Как играть</button>
  <div class="level-row" role="group" aria-label="Уровень">
    <button type="button" class="level-btn active" id="levEasy" data-lev="easy">Легкий (+ -)</button>
    <button type="button" class="level-btn" id="levMed" data-lev="medium">Средний (×)</button>
    <button type="button" class="level-btn" id="levHard" data-lev="hard">Сложный (× ÷)</button>
  </div>
  <div class="a11y-bar" role="group" aria-label="Озвучка">
    <label class="voice-toggle"><input type="checkbox" id="voiceOn" checked> Озвучивать</label>
    <button type="button" class="speak-btn" id="repeatBtn" aria-label="Повторить пример">Повторить</button>
  </div>
  <div class="task-box">
    <p class="expr" id="expr" aria-live="polite">-</p>
    <label for="answer">Ответ:</label>
    <input type="number" id="answer" autocomplete="off" inputmode="numeric" aria-describedby="score streak">
  </div>
  <div class="timer-bar"><div class="timer-fill" id="timerFill" style="width:100%"></div></div>
  <div class="stats">
    <div class="stat"><span class="stat-label">Очки</span><p class="stat-value" id="score">0</p></div>
    <div class="stat"><span class="stat-label">Серия</span><p class="stat-value streak" id="streak">0</p></div>
    <div class="stat"><span class="stat-label">Время раунда</span><p class="stat-value" id="timer">0 сек</p></div>
  </div>
  <button type="button" class="again" id="again">Новая игра</button>
  </main>
  <script>
    var level = 'easy';
    var a = 0, b = 0, op = '', result = 0;
    var totalScore = 0;
    var streak = 0;
    var startTime = 0;
    var maxTime = 10;
    var timerInterval = null;
    var exprEl = document.getElementById('expr');
    var answerEl = document.getElementById('answer');
    var scoreEl = document.getElementById('score');
    var streakEl = document.getElementById('streak');
    var timerEl = document.getElementById('timer');
    var timerFillEl = document.getElementById('timerFill');
    var warned5 = false;
    var warned3 = false;
    var voiceOn = localStorage.getItem('bystryj_voice') !== '0';
    if (document.getElementById('voiceOn')) document.getElementById('voiceOn').checked = voiceOn;
    function say(t) {
      if (!voiceOn || !window.speechSynthesis || !t) return;
      window.speechSynthesis.cancel();
      var u = new SpeechSynthesisUtterance(t);
      u.lang = 'ru-RU';
      u.rate = 0.9;
      window.speechSynthesis.speak(u);
    }
    function exprToSpeech() {
      var opWord = op === '+' ? 'плюс' : op === '-' ? 'минус' : op === '×' ? 'умножить на' : 'разделить на';
      return a + ' ' + opWord + ' ' + b + ' равно?';
    }
    function setLevel(l) {
      level = l;
      document.querySelectorAll('.level-btn').forEach(function(btn) {
        btn.classList.toggle('active', btn.dataset.lev === l);
      });
      if (l === 'easy') maxTime = 12;
      else if (l === 'medium') maxTime = 10;
      else maxTime = 8;
      nextTask();
    }
    function genTask() {
      if (level === 'easy') {
        a = 2 + Math.floor(Math.random() * 18);
        b = 2 + Math.floor(Math.random() * 18);
        op = Math.random() < 0.5 ? '+' : '-';
        if (op === '-') { if (a < b) { var t = a; a = b; b = t; } result = a - b; }
        else result = a + b;
      } else if (level === 'medium') {
        a = 2 + Math.floor(Math.random() * 9);
        b = 2 + Math.floor(Math.random() * 9);
        op = '×';
        result = a * b;
      } else {
        b = 2 + Math.floor(Math.random() * 9);
        result = 2 + Math.floor(Math.random() * 12);
        a = b * result;
        op = Math.random() < 0.5 ? '×' : '÷';
        if (op === '÷') { var ta = a; a = result; result = ta / result; }
      }
      return a + ' ' + op + ' ' + b + ' = ?';
    }
    function nextTask() {
      exprEl.textContent = genTask();
      exprEl.classList.remove('correct', 'wrong');
      answerEl.value = '';
      answerEl.focus();
      say(exprToSpeech());
      startTime = Date.now();
      warned5 = false;
      warned3 = false;
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(function() {
        var elapsed = (Date.now() - startTime) / 1000;
        timerEl.textContent = Math.floor(elapsed) + ' сек';
        var pct = Math.max(0, 100 - (elapsed / maxTime) * 100);
        timerFillEl.style.width = pct + '%';
        if (elapsed >= maxTime - 5 && elapsed < maxTime - 4 && !warned5) {
          warned5 = true;
          say('Осталось 5 секунд');
        }
        if (elapsed >= maxTime - 3 && elapsed < maxTime - 2 && !warned3) {
          warned3 = true;
          say('Осталось 3 секунды');
        }
        if (elapsed >= maxTime) {
          clearInterval(timerInterval);
          exprEl.classList.add('wrong');
          exprEl.textContent = a + ' ' + op + ' ' + b + ' = ' + result + ' (время вышло)';
          say('Время вышло. Ответ: ' + result);
          streak = 0;
          streakEl.textContent = '0';
          setTimeout(nextTask, 1200);
        }
      }, 100);
    }
    function submit() {
      var val = parseInt(answerEl.value, 10);
      if (isNaN(val)) return;
      if (timerInterval) clearInterval(timerInterval);
      if (val === result) {
        streak++;
        var elapsed = (Date.now() - startTime) / 1000;
        var bonus = Math.max(5, Math.floor(20 - elapsed * 2));
        totalScore += bonus + Math.min(streak * 2, 15);
        scoreEl.textContent = totalScore;
        streakEl.textContent = streak;
        exprEl.classList.add('correct');
        exprEl.textContent = a + ' ' + op + ' ' + b + ' = ' + result + ' ✓';
        say('Правильно. Очки: ' + totalScore + '. Серия: ' + streak);
        setTimeout(nextTask, 500);
      } else {
        exprEl.classList.add('wrong');
        exprEl.textContent = a + ' ' + op + ' ' + b + ' = ' + result + ' (неверно)';
        say('Неверно. Правильный ответ: ' + result);
        streak = 0;
        streakEl.textContent = '0';
        setTimeout(function() { nextTask(); }, 1000);
      }
      answerEl.value = '';
    }
    answerEl.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') { e.preventDefault(); submit(); }
    });
    document.getElementById('again').addEventListener('click', function() {
      totalScore = 0;
      streak = 0;
      scoreEl.textContent = '0';
      streakEl.textContent = '0';
      nextTask();
    });
    document.querySelectorAll('.level-btn').forEach(function(btn) {
      btn.addEventListener('click', function() { setLevel(btn.dataset.lev); });
    });
    document.getElementById('repeatBtn').addEventListener('click', function() {
      say(exprToSpeech());
    });
    document.getElementById('voiceOn').addEventListener('change', function() {
      voiceOn = this.checked;
      localStorage.setItem('bystryj_voice', voiceOn ? '1' : '0');
      if (voiceOn) say(exprToSpeech());
    });
    document.getElementById('introBtn').addEventListener('click', function() {
      say('Быстрый счет. Управление с клавиатуры: Tab - переход, Enter - отправить ответ или нажать кнопку, Пробел - нажать кнопку. Вам озвучат пример. Введите ответ цифрами и нажмите Enter. Осталось время озвучивается за 5 и 3 секунды. Выберите уровень: Легкий, Средний или Сложный. ');
    });
    nextTask();
  </script>
</body>
</html>
